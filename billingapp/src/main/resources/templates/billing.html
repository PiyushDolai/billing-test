<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Billing Page</title>
    <style>
        table {
            width: 80%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #total-amount {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>Billing</h1>

    <div>
        <label for="barcode">Scan Barcode:</label>
        <input type="text" id="barcode" autofocus>
    </div>

    <br>

    <table>
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="billing-items">
            </tbody>
    </table>

	<div id="total-amount">
        Total: â‚¹ <span id="total-value">0.00</span>
    </div>

    <button id="complete-billing-btn">Complete Billing</button>

    <div id="billing-completed-message" style="display: none; margin-top: 20px; color: green;">
        Billing completed successfully! <a href="/reports">View Report</a>
        <button id="new-billing-btn" style="margin-left: 10px;">Start New Billing</button>
    </div>

    <script th:inline="javascript">
        const barcodeInput = document.getElementById('barcode');
        const billingItemsTable = document.getElementById('billing-items');
        const totalValueSpan = document.getElementById('total-value');
        let cartItems = []; // Array to hold the items in the cart

        barcodeInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const barcode = barcodeInput.value.trim();
                if (barcode) {
                    fetchProductDetails(barcode);
                    barcodeInput.value = ''; // Clear the input after scanning
                }
            }
        });

        function fetchProductDetails(barcode) {
            fetch(`/api/products/${barcode}`) // Your Spring Boot endpoint
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(product => {
                    addProductToCart(product);
                    updateBillingTable();
                    updateTotalAmount();
                })
                .catch(error => {
                    console.error('Error fetching product details:', error);
                    alert('Error fetching product details. Please try again.');
                });
        }

		function addProductToCart(product) {
		    const existingItemIndex = cartItems.findIndex(item => item.id === product.id);
		    if (existingItemIndex > -1) {
		        cartItems[existingItemIndex].quantity++;
		        cartItems[existingItemIndex].total = cartItems[existingItemIndex].quantity * product.price; // Keep total for frontend display
		    } else {
		        cartItems.push({
		            id: product.id,
		            name: product.name,
		            price: product.price,
		            quantity: 1,
		            total: product.price // Keep total for frontend display
		        });
		    }
		}

        function updateBillingTable() {
            billingItemsTable.innerHTML = ''; // Clear the table

            cartItems.forEach((item, index) => {
                const row = billingItemsTable.insertRow();

                const nameCell = row.insertCell();
                nameCell.textContent = item.name;

                const priceCell = row.insertCell();
                priceCell.textContent = item.price.toFixed(2);

                const quantityCell = row.insertCell();
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.addEventListener('change', function() {
                    updateQuantity(index, parseInt(this.value));
                });
                quantityCell.appendChild(quantityInput);

                const totalCell = row.insertCell();
                totalCell.textContent = item.total.toFixed(2);

                const actionCell = row.insertCell();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeItem(index));
                actionCell.appendChild(removeButton);
            });
        }

        function updateQuantity(index, newQuantity) {
            if (newQuantity >= 1) {
                cartItems[index].quantity = newQuantity;
                cartItems[index].total = cartItems[index].quantity * cartItems[index].price;
                updateBillingTable();
                updateTotalAmount();
            }
        }

        function removeItem(index) {
            cartItems.splice(index, 1);
            updateBillingTable();
            updateTotalAmount();
        }

        function updateTotalAmount() {
            const total = cartItems.reduce((sum, item) => sum + item.total, 0);
            totalValueSpan.textContent = total.toFixed(2);
        }
		
		const completeBillingButton = document.getElementById('complete-billing-btn');
        const billingCompletedMessage = document.getElementById('billing-completed-message');
        const newBillingButton = document.getElementById('new-billing-btn');

        completeBillingButton.addEventListener('click', completeBilling);
        newBillingButton.addEventListener('click', startNewBilling);
				
		function completeBilling() {
			debugger;
            if (cartItems.length > 0) {
                fetch('/api/billing/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cartItems)
                })
				.then(response => {
		            if (!response.ok) {
		                throw new Error(`HTTP error! status: ${response.status}`);
		            }
		            return response.json(); // Now this will be the billing ID (or your success message)
		        })
		        .then(billingId => { // Rename 'billingDetails' to 'billingId' for clarity
		            console.log('Billing completed with ID:', billingId);
		            cartItems = []; // Clear the cart
		            updateBillingTable();
		            updateTotalAmount();
		            billingCompletedMessage.style.display = 'block';
		            completeBillingButton.style.display = 'none'; // Hide the complete button
		        })
                .catch(error => {
                    console.error('Error completing billing:', error);
                    alert('Error completing billing. Please try again.');
                });
            } else {
                alert('Your cart is empty. Please add items before completing billing.');
            }
        }

        function startNewBilling() {
            billingCompletedMessage.style.display = 'none';
            completeBillingButton.style.display = 'block'; // Show the complete button again
            barcodeInput.focus();
        }
		
		// Automatically focus on the barcode input when the page loads
		window.onload = function() {
		    barcodeInput.focus();
		};
    </script>
</body>
</html>